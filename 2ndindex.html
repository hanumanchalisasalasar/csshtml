<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer-to-Peer Video Call</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .card {
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 28rem;
        }
        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            z-index: 10;
        }
        .message-success {
            background-color: #48bb78;
            color: #fff;
        }
        .message-error {
            background-color: #f56565;
            color: #fff;
        }
        video {
            border-radius: 0.75rem;
            background-color: #1a202c;
            border: 2px solid #4a5568;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container">
        <div id="login-section" class="card p-8 space-y-6 text-center">
            <h1 class="text-3xl font-bold">Login</h1>
            <p>Enter your unique PIN to connect.</p>
            <div class="flex flex-col space-y-4">
                <input type="number" id="pin-input" placeholder="Enter PIN (e.g., 4505)" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400 text-white">
                <button id="login-button" class="w-full px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">Login</button>
            </div>
        </div>

        <div id="video-section" class="hidden card p-8 space-y-6 text-center">
            <h1 id="user-info" class="text-3xl font-bold"></h1>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <div class="flex flex-col items-center space-y-2 w-full">
                    <video id="local-video" autoplay muted playsinline class="w-full h-auto max-h-96"></video>
                    <p class="text-sm text-gray-400">Your Video</p>
                </div>
                <div class="flex flex-col items-center space-y-2 w-full">
                    <video id="remote-video" autoplay playsinline class="w-full h-auto max-h-96"></video>
                    <p class="text-sm text-gray-400">Friend's Video</p>
                </div>
            </div>
            <button id="start-call-button" class="w-full px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors">
                <span id="call-button-text">Start Call</span>
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const videoSection = document.getElementById('video-section');
        const pinInput = document.getElementById('pin-input');
        const loginButton = document.getElementById('login-button');
        const startCallButton = document.getElementById('start-call-button');
        const callButtonText = document.getElementById('call-button-text');
        const userInfoText = document.getElementById('user-info');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');

        // Signaling and WebRTC Globals
        let localStream;
        let peerConnection;
        let signalingChannel;
        let myPin;
        let myName;
        let otherPin;

        // Configuration
        const PINS = {
            '4505': 'Me',
            '2678': 'Friend'
        };
        // A public STUN server for NAT traversal
        const rtcConfiguration = {
            iceServers: [{
                urls: 'stun:stun.l.google.com:19302'
            }]
        };
        // A simple WebSocket echo server for signaling
        const signalingServer = 'wss://echo.websocket.events/';

        function showMessage(message, type = 'success', duration = 3000) {
            const msgBox = document.createElement('div');
            msgBox.textContent = message;
            msgBox.classList.add('message-box', type === 'success' ? 'message-success' : 'message-error');
            document.body.appendChild(msgBox);
            setTimeout(() => {
                msgBox.remove();
            }, duration);
        }

        async function initLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                return localStream;
            } catch (error) {
                console.error('Error getting user media:', error);
                showMessage('Failed to get camera/mic access. Please check permissions.', 'error');
                return null;
            }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfiguration);

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate');
                    sendMessage({
                        type: 'candidate',
                        candidate: event.candidate,
                        from: myPin,
                        to: otherPin
                    });
                }
            };

            peerConnection.ontrack = (event) => {
                console.log('Remote track received:', event.track);
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }

        function sendMessage(message) {
            if (signalingChannel.readyState === WebSocket.OPEN) {
                signalingChannel.send(JSON.stringify(message));
            } else {
                console.error('WebSocket not open. Message not sent:', message);
            }
        }

        async function createOffer() {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                console.log('Sending offer');
                sendMessage({
                    type: 'offer',
                    sdp: peerConnection.localDescription,
                    from: myPin,
                    to: otherPin
                });
                callButtonText.textContent = 'Calling...';
            } catch (error) {
                console.error('Error creating offer:', error);
                showMessage('Failed to create call offer.', 'error');
            }
        }

        async function createAnswer(offer) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                console.log('Sending answer');
                sendMessage({
                    type: 'answer',
                    sdp: peerConnection.localDescription,
                    from: myPin,
                    to: otherPin
                });
                callButtonText.textContent = 'Connected!';
            } catch (error) {
                console.error('Error creating answer:', error);
                showMessage('Failed to create call answer.', 'error');
            }
        }

        function handleSignalingMessage(message) {
            const data = JSON.parse(message.data);

            if (data.from === otherPin) {
                if (data.type === 'offer') {
                    console.log('Received offer');
                    createPeerConnection();
                    createAnswer(data.sdp);
                } else if (data.type === 'answer') {
                    console.log('Received answer');
                    peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                    callButtonText.textContent = 'Connected!';
                } else if (data.type === 'candidate' && peerConnection) {
                    console.log('Received ICE candidate');
                    peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } else if (data.from === myPin) {
                // This is an echo message from the server, ignore it.
                // In a real signaling server, you would not receive your own messages.
                console.log('Ignoring own echoed message.');
            }
        }

        function startSignaling() {
            signalingChannel = new WebSocket(signalingServer);

            signalingChannel.onopen = () => {
                console.log('Connected to signaling server.');
                showMessage('Connected to signaling server. Ready to call!', 'success');
            };

            signalingChannel.onmessage = handleSignalingMessage;

            signalingChannel.onclose = () => {
                console.warn('Signaling channel closed. Please refresh to reconnect.');
                showMessage('Connection lost. Refresh to try again.', 'error');
            };

            signalingChannel.onerror = (error) => {
                console.error('Signaling channel error:', error);
                showMessage('Signaling error. Check console for details.', 'error');
            };
        }

        loginButton.addEventListener('click', async () => {
            const pin = pinInput.value;
            if (PINS[pin]) {
                myPin = pin;
                myName = PINS[pin];
                otherPin = (myPin === '4505') ? '2678' : '4505';
                
                loginSection.classList.add('hidden');
                videoSection.classList.remove('hidden');
                userInfoText.textContent = `${myName} (PIN: ${myPin})`;

                const stream = await initLocalStream();
                if (stream) {
                    startSignaling();
                } else {
                    showMessage('Failed to get video/audio. Cannot proceed.', 'error');
                }
            } else {
                showMessage('Invalid PIN. Please enter a valid PIN.', 'error');
            }
        });

        startCallButton.addEventListener('click', () => {
            if (peerConnection && peerConnection.iceConnectionState !== 'closed') {
                showMessage('Call already in progress or connection is being established.', 'error');
                return;
            }
            createPeerConnection();
            createOffer();
            startCallButton.disabled = true;
            callButtonText.textContent = 'Calling...';
        });

        // Add a handler to re-enable button if call fails
        setInterval(() => {
            if (peerConnection && peerConnection.iceConnectionState === 'failed') {
                startCallButton.disabled = false;
                callButtonText.textContent = 'Call Failed. Try Again.';
            }
        }, 1000);

    </script>
</body>
</html>
